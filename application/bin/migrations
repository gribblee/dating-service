#!/usr/bin/env php
<?php
declare(strict_types=1);

$dsn = $_ENV['DATABASE_DSN'] ?? '';
if (!$dsn) {
    echo "DATABASE_DSN not set\n";
    exit(1);
}

$dir = __DIR__ . '/../migrations';
$mode = $argv[1] ?? 'migrate';

$pg = pg_connect($dsn);
if (!$pg) {
    echo "Cannot connect to PostgreSQL\n";
    exit(1);
}

// Таблица миграций
pg_query($pg, "
CREATE TABLE IF NOT EXISTS migrations (
    id SERIAL PRIMARY KEY,
    filename TEXT NOT NULL UNIQUE,
    executed_at TIMESTAMP NOT NULL DEFAULT NOW()
)
");

// Выполненные миграции
$res = pg_query($pg, "SELECT filename FROM migrations ORDER BY id ASC");
$executedRows = pg_fetch_all($res);
$executed = [];
if ($executedRows !== false) {
    foreach ($executedRows as $row) {
        $executed[] = $row['filename'];
    }
}

$upFiles = glob($dir . '/*.up.sql');
sort($upFiles);

if ($mode === 'migrate') {
    foreach ($upFiles as $file) {
        $basename = basename($file);
        if (in_array($basename, $executed, true)) {
            echo "[SKIP] $basename\n";
            continue;
        }

        echo "[RUN] $basename\n";
        $sql = file_get_contents($file);
        if ($sql === false) {
            echo "[ERROR] Cannot read $basename\n";
            continue;
        }

        // Транзакция
        pg_query($pg, "BEGIN");
        $result = pg_query($pg, $sql);
        if ($result === false) {
            pg_query($pg, "ROLLBACK");
            echo "[ERROR] Failed: $basename\n";
            exit(1);
        }

        $insertRes = pg_query_params($pg, "INSERT INTO migrations (filename) VALUES ($1)", [$basename]);
        if ($insertRes === false) {
            pg_query($pg, "ROLLBACK");
            echo "[ERROR] Cannot record $basename\n";
            exit(1);
        }

        pg_query($pg, "COMMIT");
        echo "[OK] $basename\n";
    }
} elseif ($mode === 'rollback') {
    $last = end($executed);
    if (!$last) {
        echo "No migrations to rollback.\n";
        exit(0);
    }

    $downFile = $dir . '/' . str_replace('.up.sql', '.down.sql', $last);
    if (!file_exists($downFile)) {
        echo "Rollback file not found: $downFile\n";
        exit(1);
    }

    echo "[ROLLBACK] $last\n";
    $sql = file_get_contents($downFile);
    if ($sql === false) {
        echo "[ERROR] Cannot read rollback file $downFile\n";
        exit(1);
    }

    pg_query($pg, "BEGIN");
    $res = pg_query($pg, $sql);
    if ($res === false) {
        pg_query($pg, "ROLLBACK");
        echo "[ERROR] Failed rollback $last\n";
        exit(1);
    }

    $delRes = pg_query_params($pg, "DELETE FROM migrations WHERE filename = $1", [$last]);
    if ($delRes === false) {
        pg_query($pg, "ROLLBACK");
        echo "[ERROR] Cannot delete migration record $last\n";
        exit(1);
    }

    pg_query($pg, "COMMIT");
    echo "[OK] $last rolled back\n";
} else {
    echo "Unknown mode: $mode\n";
    exit(1);
}
